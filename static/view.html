<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Детали Выборов</title>
    <!-- Font Awesome для иконок -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css"
      integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      /* ======= Переменные ======= */
      :root {
        --font-family: "Arial", sans-serif;
        --color-background: #f8f9fa;
        --color-card-bg: #ffffff;
        --color-border: #ddd;
        --color-shadow: rgba(0, 0, 0, 0.1);
        --color-primary: #007bff;
        --color-primary-hover: #0056b3;
        --color-danger: #dc3545;
        --color-danger-hover: #c82333;
        --color-success: #28a745;
        --color-success-hover: #218838;
        --color-modify: #17a2b8;
        --color-modify-hover: #117a8b;
        --color-text: #333;
        --color-text-secondary: #555;
        --transition-speed: 0.3s;
        --transition-speed-fast: 0.2s;
        --border-radius: 10px;
        --max-width: 1200px;
      }

      /* ======= Глобальные Стили ======= */
      body {
        font-family: var(--font-family);
        margin: 0;
        padding: 0;
        background-color: var(
          --color-background
        ); /* Светлый фон для чистого вида */
      }

      h1,
      h2,
      h3 {
        color: var(--color-text);
        margin-bottom: 10px;
      }

      p {
        color: var(--color-text-secondary);
        line-height: 1.6;
      }

      /* ======= Контейнер ======= */
      .container {
        max-width: var(--max-width);
        margin: 0 auto;
        padding: 20px;
      }

      /* ======= Стилизация Заголовка ======= */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      header h1 {
        font-size: 2rem;
      }

      header div {
        display: flex;
        gap: 10px;
      }

      /* ======= Стилизация Кнопок ======= */
      .logout-btn,
      #back-btn {
        margin-top: 10px;
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        text-decoration: none;
        transition: background-color var(--transition-speed),
          transform var(--transition-speed-fast);
      }

      .logout-btn {
        background-color: var(--color-danger);
      }

      .logout-btn:hover {
        background-color: var(--color-danger-hover);
        transform: scale(1.05);
      }

      #back-btn {
        background-color: var(--color-primary);
      }

      #back-btn:hover {
        background-color: var(--color-primary-hover);
        transform: scale(1.05);
      }

      /* ======= Стилизация Иконок Кнопок ======= */
      .logout-btn i,
      #back-btn i,
      .vote-btn i {
        margin-right: 8px; /* Пробел между иконкой и текстом */
        vertical-align: middle; /* Вертикальное выравнивание иконки с текстом */
      }

      /* ======= Стилизация Деталей Выборов ======= */
      .election-details {
        margin-bottom: 40px;
      }

      .election-details h2 {
        font-size: 1.5rem;
      }

      /* ======= Стилизация Списка Кандидатов ======= */
      .candidate-list {
        display: flex;
        flex-direction: column;
        gap: 20px; /* Пробел между карточками кандидатов */
      }

      /* ======= Стилизация Карточки Кандидата ======= */
      .candidate-card {
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: 0 4px 10px var(--color-shadow);
        background-color: var(--color-card-bg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: transform var(--transition-speed),
          box-shadow var(--transition-speed);
      }

      .candidate-card:hover {
        transform: translateY(-5px); /* Лёгкое поднятие при наведении */
        box-shadow: 0 8px 20px var(--color-shadow);
      }

      .candidate-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .candidate-info h3 {
        margin-bottom: 5px;
        font-size: 1.25rem;
        color: var(--color-text);
      }

      .candidate-info p {
        font-size: 14px;
        color: var(--color-text-secondary);
      }

      .vote-count {
        font-size: 1.1em;
        color: var(--color-text-secondary);
      }

      /* ======= Стилизация Кнопки Голоса ======= */
      .vote-btn {
        background-color: var(--color-success);
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        border: none;
        font-weight: bold;
        transition: background-color var(--transition-speed),
          transform var(--transition-speed-fast);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .vote-btn:hover {
        background-color: var(--color-success-hover);
        transform: scale(1.05);
      }

      .vote-btn i {
        margin-right: 8px;
      }

      .vote-btn.disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* ======= Адаптивный Дизайн ======= */
      @media (max-width: 768px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        header h1 {
          margin-bottom: 20px;
        }

        header div {
          display: flex;
          gap: 10px;
        }

        .candidate-card {
          flex-direction: column;
          align-items: flex-start;
        }

        .vote-btn {
          margin-top: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Раздел Заголовка с Кнопками Назад и Выхода -->
      <header>
        <h1>Детали выборов</h1>
        <div>
          <button
            id="back-btn"
            onclick="window.location.href='elections.html';"
          >
            <i class="fa-solid fa-arrow-left"></i> Назад к выборам
          </button>
          <button id="logout-btn" class="logout-btn">
            <i class="fa-solid fa-sign-out-alt"></i> Выйти
          </button>
        </div>
      </header>

      <!-- Название и Описание Выборов -->
      <div class="election-details">
        <h2 id="election-title">Название: Загрузка...</h2>
        <p id="election-description">Описание: Загрузка...</p>
      </div>

      <!-- Список Кандидатов -->
      <h3>Кандидаты</h3>
      <div class="candidate-list" id="candidate-list">
        <!-- Карточки кандидатов будут заполнены здесь -->
      </div>
    </div>

    <script>
      const electionId = new URLSearchParams(window.location.search).get("id");

      // Функция для проверки, проголосовал ли пользователь на выборах
      function checkIfVoted() {
        return fetch(
          `http://localhost:3000/votes/voted?election_id=${electionId}`,
          {
            method: "GET",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("jwt_token"),
            },
          }
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error("Не удалось проверить статус голосования");
            }
            return response.json();
          })
          .then((data) => {
            return data.voted;
          })
          .catch((error) => {
            console.error("Ошибка при проверке голосования:", error);
            alert("Не удалось проверить статус голосования.");
            return false;
          });
      }

      // Функция для отключения кнопок голосования
      function disableVoteButtons() {
        const voteButtons = document.querySelectorAll(".vote-btn");
        voteButtons.forEach((button) => {
          button.classList.add("disabled");
          button.disabled = true;
          button.innerHTML =
            '<i class="fa-solid fa-check"></i> Вы проголосовали';
        });
      }

      // Функция для активации кнопок голосования
      function enableVoteButtons() {
        const voteButtons = document.querySelectorAll(".vote-btn");
        voteButtons.forEach((button) => {
          button.classList.remove("disabled");
          button.disabled = false;
          button.innerHTML = '<i class="fa-solid fa-thumbs-up"></i> Голосовать';
        });
      }

      // Получение деталей выборов и кандидатов
      function fetchElectionDetails() {
        // Получение Деталей Выборов
        fetch(`http://localhost:3000/elections/${electionId}`, {
          method: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("jwt_token"),
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Не удалось получить детали выборов");
            }
            return response.json();
          })
          .then((election) => {
            document.getElementById(
              "election-title"
            ).innerText = `Название: ${election.title}`;
            document.getElementById(
              "election-description"
            ).innerText = `Описание: ${election.description}`;
          })
          .catch((error) => {
            console.error("Ошибка при получении деталей выборов:", error);
            alert("Не удалось загрузить детали выборов.");
            document.getElementById("election-title").innerText =
              "Название: N/A";
            document.getElementById("election-description").innerText =
              "Описание: N/A";
          });

        // Получение Кандидатов
        fetch(`http://localhost:3000/elections/${electionId}/candidates`, {
          method: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("jwt_token"),
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Не удалось получить кандидатов");
            }
            return response.json();
          })
          .then((candidates) => {
            const candidateList = document.getElementById("candidate-list");
            candidateList.innerHTML = ""; // Очистить предыдущих кандидатов

            if (candidates.length === 0) {
              candidateList.innerHTML =
                "<p>Кандидатов нет. Добавьте одного!</p>";
              return;
            }

            candidates.forEach((candidate) => {
              // Создание карточки кандидата
              const card = document.createElement("div");
              card.className = "candidate-card";

              // Информация о кандидате
              const candidateInfo = document.createElement("div");
              candidateInfo.className = "candidate-info";

              const name = document.createElement("h3");
              name.innerText = candidate.name;
              candidateInfo.appendChild(name);

              const description = document.createElement("p");
              description.innerText = candidate.description;
              candidateInfo.appendChild(description);

              const voteCount = document.createElement("div");
              voteCount.className = "vote-count";
              voteCount.innerText = `Голоса: ${candidate.votes_count || 0}`;
              candidateInfo.appendChild(voteCount);

              // Кнопка Голоса
              const voteButton = document.createElement("button");
              voteButton.className = "vote-btn";
              voteButton.innerHTML =
                '<i class="fa-solid fa-thumbs-up"></i> Голосовать';
              voteButton.onclick = () =>
                voteForCandidate(candidate.id, voteCount);

              // Добавление информации и кнопки в карточку
              card.appendChild(candidateInfo);
              card.appendChild(voteButton);

              // Добавление карточки в список
              candidateList.appendChild(card);
            });

            // После загрузки кандидатов, проверить статус голосования
            checkIfVoted().then((voted) => {
              if (voted) {
                disableVoteButtons();
              } else {
                enableVoteButtons();
              }
            });
          })
          .catch((error) => {
            console.error("Ошибка при получении кандидатов:", error);
            alert("Не удалось загрузить кандидатов.");
            const candidateList = document.getElementById("candidate-list");
            candidateList.innerHTML = "<p>Ошибка при загрузке кандидатов.</p>";
          });
      }

      // Голосование за кандидата
      function voteForCandidate(candidateId, voteCountElement) {
        // Перед голосованием, проверить, проголосовал ли пользователь
        checkIfVoted().then((voted) => {
          if (voted) {
            alert("Вы уже проголосовали на этих выборах.");
            return;
          }

          fetch("http://localhost:3000/votes", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("jwt_token"),
            },
            body: JSON.stringify({ candidate_id: candidateId }),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Не удалось отдать голос");
              }
              return response.json();
            })
            .then((data) => {
              alert("Голос успешно отдан!");
              // Обновить счетчик голосов на странице
              const currentVoteCount = parseInt(
                voteCountElement.innerText.split(": ")[1]
              );
              voteCountElement.innerText = `Голоса: ${currentVoteCount + 1}`;

              // Отключить кнопки голосования после успешного голосования
              disableVoteButtons();
            })
            .catch((error) => {
              console.error("Ошибка при голосовании:", error);
              alert("Ошибка при голосовании: " + error.message);
            });
        });
      }

      // Функциональность Выхода
      document
        .getElementById("logout-btn")
        .addEventListener("click", function () {
          // Подтверждение выхода
          if (confirm("Вы уверены, что хотите выйти?")) {
            // Удаление JWT токена из localStorage
            localStorage.removeItem("jwt_token");
            // Перенаправление на страницу аутентификации
            window.location.href = "index.html"; // Замените на вашу реальную страницу входа
          }
        });

      // Загрузка деталей выборов при загрузке страницы
      window.onload = fetchElectionDetails;
    </script>
  </body>
</html>
