<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Активные выборы</title>
    <!-- Font Awesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css"
      integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Include jwt-decode via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <style>
      /* ======= Variables ======= */
      :root {
        --font-family: "Arial", sans-serif;
        --color-background: #f8f9fa;
        --color-card-bg: #ffffff;
        --color-border: #ddd;
        --color-shadow: rgba(0, 0, 0, 0.1);
        --color-primary: #007bff;
        --color-primary-hover: #0056b3;
        --color-danger: #dc3545;
        --color-danger-hover: #c82333;
        --color-success: #28a745;
        --color-success-hover: #218838;
        --color-text: #333;
        --color-text-secondary: #555;
        --transition-speed: 0.3s;
        --transition-speed-fast: 0.2s;
        --border-radius: 10px;
        --color-modify: #17a2b8;
        --color-modify-hover: #117a8b;
        --max-width: 1200px;
        --color-tag: #b9b9b9;
        --color-tag-hover: #868686;
        --color-restricted-bg: #e0e0e0; /* Gray background for restricted elections */
        --color-restricted-text: #777; /* Gray text for restricted elections */
      }

      /* ======= Global Styles ======= */
      body {
        font-family: var(--font-family);
        margin: 0;
        padding: 0;
        background-color: var(--color-background);
      }

      h1,
      h2,
      h3 {
        color: var(--color-text);
      }

      /* ======= Container ======= */
      .container {
        max-width: var(--max-width);
        margin: 0 auto;
        padding: 20px;
      }

      /* ======= Navigation Bar Styles ======= */
      .navbar {
        background-color: var(--color-primary);
        padding: 10px 20px;
      }

      .nav-menu {
        list-style: none;
        display: flex;
        gap: 20px;
        margin: 0;
        padding: 0;
      }

      .nav-item {
        position: relative;
      }

      .nav-link {
        color: #fff;
        text-decoration: none;
        font-weight: bold;
        cursor: pointer;
        display: block;
        padding: 8px 12px;
        transition: background-color var(--transition-speed);
      }

      .nav-link:hover {
        background-color: var(--color-primary-hover);
        border-radius: var(--border-radius);
      }

      /* Dropdown Menu Styles */
      .dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background-color: var(--color-card-bg);
        min-width: 150px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        border-radius: var(--border-radius);
        z-index: 1000;
      }

      .dropdown-menu li {
        border-bottom: 1px solid var(--color-border);
      }

      .dropdown-menu li:last-child {
        border-bottom: none;
      }

      .dropdown-link {
        color: var(--color-text);
        padding: 10px 16px;
        text-decoration: none;
        display: block;
        transition: background-color var(--transition-speed);
      }

      .dropdown-link:hover {
        background-color: var(--color-background);
      }

      /* Show Dropdown on Hover */
      .dropdown:hover .dropdown-menu {
        display: block;
      }

      /* Responsive Adjustments */
      @media (max-width: 768px) {
        .nav-menu {
          flex-direction: column;
          gap: 10px;
        }

        .dropdown-menu {
          position: static;
          box-shadow: none;
        }
      }

      /* ======= Election List Container ======= */
      .election-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 columns layout */
        gap: 20px; /* Space between cards */
        margin-top: 20px;
      }

      /* ======= Election Card Styling ======= */
      .election-card {
        display: flex;
        flex-direction: column;
        padding: 20px;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        box-shadow: 0 4px 10px var(--color-shadow);
        background-color: var(--color-card-bg); /* White background for cards */
        transition: transform var(--transition-speed) ease,
          box-shadow var(--transition-speed) ease;
      }

      .election-card:hover {
        transform: translateY(-5px); /* Subtle lift effect */
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }

      /* ======= Restricted Election Styling ======= */
      .election-card.restricted {
        background-color: var(--color-restricted-bg);
        color: var(--color-restricted-text);
        box-shadow: none;
      }

      /* ======= Card Title and Description ======= */
      .election-card h3 {
        margin-bottom: 10px;
        font-size: 1.25rem;
        color: var(--color-text);
      }

      .election-card.restricted h3 {
        color: var(--color-restricted-text);
      }

      .election-card p {
        margin-bottom: 10px;
        font-size: 14px;
        color: var(--color-text-secondary);
        line-height: 1.5;
      }

      /* ======= Tags Styling ======= */
      .tag {
        display: inline-block;
        background-color: var(--color-tag); /* Tag color */
        color: #fff; /* Text color */
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        margin: 10px 5px;
        transition: background-color var(--transition-speed);
      }

      .tag:hover {
        background-color: var(--color-tag-hover); /* Darker on hover */
      }

      /* ======= Button Styling ======= */
      .view-btn,
      .modify-btn,
      .delete-btn {
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        text-decoration: none;
        transition: background-color var(--transition-speed),
          transform var(--transition-speed-fast);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .view-btn {
        background-color: var(--color-primary);
      }

      .view-btn:hover {
        background-color: var(--color-primary-hover);
        transform: scale(1.05);
      }

      .modify-btn {
        background-color: var(--color-modify);
      }

      .modify-btn:hover {
        background-color: var(--color-modify-hover);
        transform: scale(1.05);
      }

      .delete-btn {
        background-color: var(--color-danger);
      }

      .delete-btn:hover {
        background-color: var(--color-danger-hover);
        transform: scale(1.05);
      }

      /* ======= Restricted Message Styling ======= */
      .restricted-message {
        margin-top: 10px;
        font-size: 14px;
        color: var(--color-danger);
        font-weight: bold;
      }

      /* ======= Responsive Design ======= */
      @media (max-width: 768px) {
        .election-list {
          grid-template-columns: 1fr;
          padding: 0 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header Section -->
      <header>
        <nav class="navbar">
          <ul class="nav-menu">
            <!-- Выборы Dropdown -->
            <li class="nav-item dropdown">
              <a href="#" class="nav-link">Выборы &#9662;</a>
              <ul class="dropdown-menu">
                <li>
                  <a
                    href="create.html"
                    class="dropdown-link"
                    id="create-election-link"
                    >Создать</a
                  >
                </li>
                <li>
                  <a href="active.html" class="dropdown-link">Активные</a>
                </li>
                <li>
                  <a href="completed.html" class="dropdown-link">Завершенные</a>
                </li>
              </ul>
            </li>

            <!-- Профиль Dropdown -->
            <li class="nav-item dropdown">
              <a href="#" class="nav-link">Профиль &#9662;</a>
              <ul class="dropdown-menu">
                <li>
                  <a href="profile.html" class="dropdown-link">Мой профиль</a>
                </li>
                <li>
                  <a href="#" class="dropdown-link" id="logout-link">Выйти</a>
                </li>
              </ul>
            </li>
          </ul>
        </nav>
      </header>

      <!-- Active Elections List -->
      <h1>Активные выборы</h1>
      <div class="election-list" id="election-list">
        <!-- Election Cards will be populated here -->
      </div>
    </div>

    <script>
      // Function to decode JWT and retrieve claims
      function getJwtClaims() {
        const token = localStorage.getItem("jwt_token");
        if (!token) return null;

        try {
          const decoded = jwt_decode(token);
          return decoded;
        } catch (error) {
          console.error("Invalid JWT token", error);
          return null;
        }
      }

      // Function to check JWT token and redirect if not present or invalid
      function checkAuthentication() {
        const token = localStorage.getItem("jwt_token");
        if (!token) {
          alert("Вы не вошли в систему. Пожалуйста, войдите сначала.");
          window.location.href = "index.html"; // Replace with your actual login page
          return;
        }

        const claims = getJwtClaims();
        if (!claims) {
          alert("Неверный токен. Пожалуйста, войдите снова.");
          localStorage.removeItem("jwt_token");
          window.location.href = "index.html"; // Replace with your actual login page
          return;
        }

        // Check token expiration if 'exp' claim exists
        if (claims.exp) {
          const currentTime = Date.now() / 1000; // in seconds
          if (claims.exp < currentTime) {
            alert("Сессия истекла. Пожалуйста, войдите снова.");
            localStorage.removeItem("jwt_token");
            window.location.href = "index.html"; // Replace with your actual login page
            return;
          }
        }
      }

      // Function to determine if the user is an organizer
      function isUserOrganizer() {
        const claims = getJwtClaims();
        if (claims && claims.is_organizer) {
          return true;
        }
        return false;
      }

      // Function to get the current user's ID
      function getCurrentUserId() {
        const claims = getJwtClaims();
        if (claims && claims.id) {
          return claims.id;
        }
        return null;
      }

      // Function to update UI based on user role
      function updateHeaderBasedOnRole() {
        const createElectionLink = document.getElementById(
          "create-election-link"
        );
        if (createElectionLink) {
          if (isUserOrganizer()) {
            createElectionLink.style.display = "block";
          } else {
            createElectionLink.style.display = "none";
          }
        }
      }

      // Function to handle logout
      function handleLogout() {
        if (confirm("Вы уверены, что хотите выйти?")) {
          localStorage.removeItem("jwt_token");
          window.location.href = "index.html"; // Redirect to login page
        }
      }

      // Attach event listener to logout link
      const logoutLink = document.getElementById("logout-link");
      if (logoutLink) {
        logoutLink.addEventListener("click", function (e) {
          e.preventDefault();
          handleLogout();
        });
      }

      // Function to fetch all active elections
      function fetchAllElections() {
        return fetch("http://localhost:3000/elections", {
          // Changed endpoint to /elections
          method: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("jwt_token"),
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Не удалось получить все выборы");
            }
            return response.json();
          })
          .catch((error) => {
            console.error("Ошибка при получении всех выборов:", error);
            alert("Не удалось загрузить выборы");
            return [];
          });
      }

      // Function to fetch filtered elections
      function fetchFilteredElections() {
        return fetch("http://localhost:3000/elections/filtered", {
          method: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("jwt_token"),
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Не удалось получить отфильтрованные выборы");
            }
            return response.json();
          })
          .catch((error) => {
            console.error(
              "Ошибка при получении отфильтрованных выборов:",
              error
            );
            alert("Не удалось загрузить отфильтрованные выборы");
            return [];
          });
      }

      // Function to fetch elections created by the user
      function fetchUserCreatedElections() {
        return fetch("http://localhost:3000/elections/created", {
          method: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("jwt_token"),
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Не удалось получить ваши выборы");
            }
            return response.json();
          })
          .catch((error) => {
            console.error("Ошибка при получении ваших выборов:", error);
            alert("Не удалось загрузить ваши выборы");
            return [];
          });
      }

      // Function to fetch tags for a specific election
      function fetchElectionTags(electionId) {
        return fetch(`http://localhost:3000/elections/${electionId}/tags`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + localStorage.getItem("jwt_token"),
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Не удалось получить теги для выборов");
            }
            return response.json();
          })
          .then((tags) => {
            return tags; // Return the array of tags
          })
          .catch((error) => {
            console.error("Ошибка при получении тегов:", error);
            return []; // Return empty array on error
          });
      }

      // Function to display elections
      async function displayElections(
        allElections,
        filteredElections,
        userElections
      ) {
        const electionList = document.getElementById("election-list");
        electionList.innerHTML = ""; // Clear any existing elections

        if (allElections.length === 0) {
          electionList.innerHTML = "<p>Активных выборов нет.</p>";
          return;
        }

        // Create a set of filtered election IDs for quick lookup
        const filteredElectionIds = new Set(filteredElections.map((e) => e.id));

        // Create a set of user-created election IDs
        const userElectionIds = new Set(userElections.map((e) => e.id));
        const userIsOrganizer = isUserOrganizer();

        // Fetch tags for all elections
        const electionsWithTagsPromises = allElections.map(async (election) => {
          const tags = await fetchElectionTags(election.id);
          return { ...election, tags };
        });

        const electionsWithTags = await Promise.all(electionsWithTagsPromises);

        electionsWithTags.forEach((election) => {
          // Determine if the election is accessible (passes the filter OR is created by the user)
          const isCreator = userElectionIds.has(election.id);
          const isAccessible =
            filteredElectionIds.has(election.id) || isCreator;

          // Create election card
          const card = document.createElement("div");
          card.className = "election-card";
          if (!isAccessible) {
            card.classList.add("restricted");
          }

          // Title
          const title = document.createElement("h3");
          title.innerText = election.title;
          card.appendChild(title);

          // Description
          const description = document.createElement("p");
          description.innerText =
            election.description.length > 100
              ? election.description.substring(0, 100) + "..."
              : election.description;
          card.appendChild(description);

          // Tags
          const tagsContainer = document.createElement("div");
          if (election.tags && election.tags.length > 0) {
            election.tags.forEach((tag) => {
              const tagElement = document.createElement("span");
              tagElement.className = "tag";
              tagElement.innerText = tag.name;
              tagsContainer.appendChild(tagElement);
            });
          }
          card.appendChild(tagsContainer);

          if (isAccessible) {
            // Button Container
            const buttonContainer = document.createElement("div");
            buttonContainer.style.display = "flex";
            buttonContainer.style.gap = "10px";
            buttonContainer.style.marginTop = "auto"; // Push buttons to bottom

            // View Election Button
            const viewButton = document.createElement("a");
            viewButton.href = "view.html?id=" + election.id;
            viewButton.className = "view-btn";
            viewButton.innerHTML =
              '<i class="fa-solid fa-eye"></i> Просмотреть';
            buttonContainer.appendChild(viewButton);

            // Modify Election Button (only for organizers and if the user is the creator)
            if (userIsOrganizer && isCreator) {
              const modifyButton = document.createElement("a");
              modifyButton.href = "modify.html?id=" + election.id; // Redirect to edit page
              modifyButton.className = "modify-btn";
              modifyButton.innerHTML =
                '<i class="fa-solid fa-edit"></i> Редактировать';
              buttonContainer.appendChild(modifyButton);
            }

            // Delete Election Button (only for organizers and if the user is the creator)
            if (userIsOrganizer && isCreator) {
              const deleteButton = document.createElement("button");
              deleteButton.className = "delete-btn";
              deleteButton.innerHTML =
                '<i class="fa-solid fa-trash-alt"></i> Удалить';
              deleteButton.onclick = function () {
                deleteElection(election.id);
              };
              buttonContainer.appendChild(deleteButton);
            }

            // Append button container to card
            card.appendChild(buttonContainer);
          } else {
            // Display a message indicating restrictions
            const restrictedMessage = document.createElement("p");
            restrictedMessage.className = "restricted-message";
            restrictedMessage.innerText =
              "Вы не соответствуете ограничениям для просмотра этих выборов";
            card.appendChild(restrictedMessage);
          }

          // Append card to list
          electionList.appendChild(card);
        });
      }

      // Delete Election function
      function deleteElection(id) {
        if (confirm("Вы уверены, что хотите удалить эти выборы?")) {
          fetch("http://localhost:3000/elections/" + id, {
            method: "DELETE",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("jwt_token"),
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Не удалось удалить выборы");
              }
              alert("Выборы успешно удалены!");
              initializePage(); // Refresh the list of elections
            })
            .catch((error) => {
              console.error("Ошибка при удалении выборов:", error);
              alert("Не удалось удалить выборы");
            });
        }
      }

      // Function to initialize the page by fetching data and updating UI
      async function initializePage() {
        // Fetch all elections
        const allElections = await fetchAllElections();

        // Fetch filtered elections
        const filteredElections = await fetchFilteredElections();

        // Fetch elections created by the user
        const userElections = await fetchUserCreatedElections();

        // Display elections with accessibility information
        displayElections(allElections, filteredElections, userElections);
      }

      // Initialize the Active Elections Page by fetching data and updating UI
      window.onload = function () {
        checkAuthentication();
        updateHeaderBasedOnRole();
        initializePage();
      };
    </script>
  </body>
</html>
